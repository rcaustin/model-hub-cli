#!/usr/bin/env bash

set -e

VENV_DIR=".venv"
VENV_PYTHON="$VENV_DIR/bin/python3"

function print_usage {
  echo "Usage: ./run install | test | /absolute/path/to/file"
}

function run_install {
  #bash setup.sh
  echo "Setting up model-hub-cli environment..."

  # Check if Python is available
  if ! command -v python3 &> /dev/null; then
    echo "ERROR: Python3 is not installed or not in PATH"
    echo "Please install Python 3.8+ and try again"
    exit 1
  fi

  # Create virtual environment
  echo "Creating virtual environment..."
  python3 -m venv .venv
  if [ $? -ne 0 ]; then
    echo "ERROR: Failed to create virtual environment"
    exit 1
  fi

  # Activate virtual environment
  echo "Activating virtual environment..."
  source .venv/bin/activate
  if [ $? -ne 0 ]; then
    echo "ERROR: Failed to activate virtual environment"
    exit 1
  fi

  # Upgrade pip
  echo "Upgrading pip..."
  python -m pip install --upgrade pip

  # Install dependencies
  echo "Installing dependencies..."
  pip install -r requirements.txt
  if [ $? -ne 0 ]; then
    echo "ERROR: Failed to install dependencies"
    exit 1
  fi

  echo ""
  echo "âœ… Setup complete! Virtual environment created in .venv/"
  echo "To activate the virtual environment manually, run: source .venv/bin/activate"
  echo "To run the application, use: ./run [command]"
}

function run_test {
  if [ ! -f "$VENV_PYTHON" ]; then
    echo "Error: Virtual environment not found. Run './run.sh install' first."
    exit 1
  fi

  source $VENV_DIR/bin/activate

  "$VENV_PYTHON" -m coverage run -m pytest -v tests/ || true
  "$VENV_PYTHON" -m coverage report
}

function run_program {
  local file_path="$1"
  if [ ! -f "$VENV_PYTHON" ]; then
    echo "Error: Virtual environment not found. Run './run.sh install' first."
    exit 1
  fi

  source $VENV_DIR/bin/activate

  "$VENV_PYTHON" -m src.commands.catalogue_runner "$file_path"
}

# ---- Main ----

if [ $# -ne 1 ]; then
  print_usage
  exit 1
fi

ARG="$1"

case "$ARG" in
  install)
    run_install
    ;;
  test)
    run_test
    ;;
  /*)
    run_program "$ARG"
    ;;
  *)
    print_usage
    exit 1
    ;;
esac

